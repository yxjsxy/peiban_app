<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªä¼´App APIæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #ff9a9e;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        button {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ff9a9e;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left-color: #4caf50;
        }
        .error {
            border-left-color: #f44336;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .token-display {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ é™ªä¼´App APIæµ‹è¯•å·¥å…·</h1>
        
        <div class="info">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>åç«¯åœ°å€ï¼šhttp://localhost:5000</li>
                <li>å¼€å‘ç¯å¢ƒéªŒè¯ç ï¼š<strong>123456</strong></li>
                <li>æŒ‰é¡ºåºç‚¹å‡»æŒ‰é’®æµ‹è¯•å„ä¸ªåŠŸèƒ½</li>
                <li>æµ‹è¯•ç»“æœä¼šæ˜¾ç¤ºåœ¨ä¸‹æ–¹</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>1. åŸºç¡€æµ‹è¯•</h2>
            <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <button onclick="testAPIInfo()">æŸ¥çœ‹APIä¿¡æ¯</button>
            <div id="health-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>2. ç”¨æˆ·è®¤è¯</h2>
            <input type="text" id="phone-input" placeholder="æ‰‹æœºå·" value="13800138000" style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <button onclick="sendCode()">å‘é€éªŒè¯ç </button>
            <button onclick="login()">ç™»å½•ï¼ˆéªŒè¯ç ï¼š123456ï¼‰</button>
            <button onclick="getMe()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <button onclick="createMultipleUsers()">åˆ›å»ºå¤šä¸ªæµ‹è¯•ç”¨æˆ·</button>
            <div id="auth-result" class="result" style="display:none;"></div>
            <div id="token-display" class="token-display" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>3. æ‰“å¡åŠŸèƒ½</h2>
            <button onclick="checkin()">æ‰“å¡</button>
            <button onclick="getCheckinStatus()">æŸ¥çœ‹æ‰“å¡çŠ¶æ€</button>
            <button onclick="getCheckinCalendar()">æŸ¥çœ‹æ‰“å¡æ—¥å†</button>
            <div id="checkin-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>4. ç”¨æˆ·èµ„æ–™</h2>
            <button onclick="getProfile()">è·å–èµ„æ–™</button>
            <button onclick="updateProfile()">æ›´æ–°èµ„æ–™</button>
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px;">ä¸Šä¼ å¤´åƒï¼š</label>
                <input type="file" id="avatar-input" accept="image/*" style="margin-bottom: 10px;">
                <button onclick="uploadAvatar()">ä¸Šä¼ å¤´åƒ</button>
            </div>
            <div id="profile-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>5. æ—¥å¿—åŠŸèƒ½</h2>
            <button onclick="getLogs()">è·å–æ—¥å¿—åˆ—è¡¨</button>
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 5px;">æ—¥å¿—é…å­—ï¼ˆæœ€å¤š500å­—ï¼‰ï¼š</label>
                <textarea id="log-content" placeholder="è®°å½•ä»Šå¤©çš„ç¾å¥½æ—¶å…‰..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; min-height: 80px;"></textarea>
                <label style="display: block; margin-bottom: 5px;">é€‰æ‹©å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰ï¼š</label>
                <input type="file" id="log-images-input" accept="image/*" multiple style="margin-bottom: 10px;">
                <div id="image-preview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;"></div>
                <button onclick="createLog()">åˆ›å»ºæ—¥å¿—</button>
            </div>
            <div id="logs-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>6. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="full-test-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let token = localStorage.getItem('api_token') || '';

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result ' + (isError ? 'error' : 'success');
            element.textContent = JSON.stringify(data, null, 2);
        }

        function updateToken(newToken) {
            if (newToken) {
                token = newToken;
                localStorage.setItem('api_token', token);
                const tokenDisplay = document.getElementById('token-display');
                tokenDisplay.style.display = 'block';
                tokenDisplay.innerHTML = '<strong>å½“å‰Token:</strong> ' + token.substring(0, 50) + '...';
            }
        }

        async function testHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                showResult('health-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('health-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function testAPIInfo() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                showResult('health-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('health-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function sendCode() {
            const phone = document.getElementById('phone-input').value || '13800138000';
            try {
                const response = await fetch(`${API_BASE}/api/auth/send-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });
                const data = await response.json();
                showResult('auth-result', { status: 'æˆåŠŸ', phone, data });
            } catch (error) {
                showResult('auth-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function login() {
            const phone = document.getElementById('phone-input').value || '13800138000';
            try {
                const response = await fetch(`${API_BASE}/api/auth/verify-phone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, code: '123456' })
                });
                const data = await response.json();
                if (data.token) {
                    updateToken(data.token);
                    showResult('auth-result', { status: 'ç™»å½•æˆåŠŸ', phone, user: data.user, token: data.token.substring(0, 30) + '...' });
                } else {
                    showResult('auth-result', { status: 'ç™»å½•å¤±è´¥', data }, true);
                }
            } catch (error) {
                showResult('auth-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function getMe() {
            if (!token) {
                showResult('auth-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showResult('auth-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('auth-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function checkin() {
            if (!token) {
                showResult('checkin-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/checkin`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showResult('checkin-result', { status: 'æ‰“å¡æˆåŠŸ', data });
            } catch (error) {
                const errorText = await error.response?.text();
                showResult('checkin-result', { status: 'å¤±è´¥', error: error.message, details: errorText }, true);
            }
        }

        async function getCheckinStatus() {
            if (!token) {
                showResult('checkin-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/checkin/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showResult('checkin-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('checkin-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function getCheckinCalendar() {
            if (!token) {
                showResult('checkin-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/checkin/calendar`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showResult('checkin-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('checkin-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function getProfile() {
            if (!token) {
                showResult('profile-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showResult('profile-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('profile-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function updateProfile() {
            if (!token) {
                showResult('profile-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: 'æµ‹è¯•ç”¨æˆ·' + Math.floor(Math.random() * 1000),
                        gender: 'male',
                        signature: 'è¿™æ˜¯é€šè¿‡APIæµ‹è¯•æ›´æ–°çš„ä¸ªæ€§ç­¾å'
                    })
                });
                const data = await response.json();
                showResult('profile-result', { status: 'æ›´æ–°æˆåŠŸ', data });
            } catch (error) {
                showResult('profile-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function uploadAvatar() {
            if (!token) {
                showResult('profile-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            
            const fileInput = document.getElementById('avatar-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('profile-result', { status: 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', error: 'æ²¡æœ‰é€‰æ‹©æ–‡ä»¶' }, true);
                return;
            }

            if (!file.type.startsWith('image/')) {
                showResult('profile-result', { status: 'æ–‡ä»¶æ ¼å¼é”™è¯¯', error: 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶' }, true);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('avatar', file);

                const response = await fetch(`${API_BASE}/api/user/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (data.avatar) {
                    showResult('profile-result', { 
                        status: 'ä¸Šä¼ æˆåŠŸ', 
                        avatar: data.avatar,
                        avatarUrl: `${API_BASE}/uploads/${data.avatar}`,
                        user: data.user 
                    });
                } else {
                    showResult('profile-result', { status: 'ä¸Šä¼ å¤±è´¥', data }, true);
                }
            } catch (error) {
                showResult('profile-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function getLogs() {
            if (!token) {
                showResult('logs-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/logs`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                showResult('logs-result', { status: 'æˆåŠŸ', data });
            } catch (error) {
                showResult('logs-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        // å›¾ç‰‡é¢„è§ˆ
        document.getElementById('log-images-input').addEventListener('change', function(e) {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            const files = Array.from(e.target.files).slice(0, 9);
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '100%';
                        img.style.height = '100px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '5px';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        async function createLog() {
            if (!token) {
                showResult('logs-result', { status: 'è¯·å…ˆç™»å½•', error: 'æ²¡æœ‰token' }, true);
                return;
            }

            const content = document.getElementById('log-content').value;
            const fileInput = document.getElementById('log-images-input');
            const files = Array.from(fileInput.files).slice(0, 9);

            if (!content.trim() && files.length === 0) {
                showResult('logs-result', { status: 'è¯·è‡³å°‘è¾“å…¥é…å­—æˆ–ä¸Šä¼ å›¾ç‰‡', error: 'å†…å®¹ä¸èƒ½ä¸ºç©º' }, true);
                return;
            }

            if (content.length > 500) {
                showResult('logs-result', { status: 'é…å­—ä¸èƒ½è¶…è¿‡500å­—', error: `å½“å‰${content.length}å­—` }, true);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('content', content);
                
                files.forEach((file, index) => {
                    formData.append(`image${index}`, file);
                });

                const response = await fetch(`${API_BASE}/api/logs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (data.id) {
                    showResult('logs-result', { 
                        status: 'åˆ›å»ºæˆåŠŸ', 
                        logId: data.id,
                        content: data.content,
                        images: data.images,
                        createdAt: data.created_at
                    });
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('log-content').value = '';
                    document.getElementById('log-images-input').value = '';
                    document.getElementById('image-preview').innerHTML = '';
                } else {
                    showResult('logs-result', { status: 'åˆ›å»ºå¤±è´¥', data }, true);
                }
            } catch (error) {
                showResult('logs-result', { status: 'å¤±è´¥', error: error.message }, true);
            }
        }

        async function runFullTest() {
            const result = document.getElementById('full-test-result');
            result.style.display = 'block';
            result.className = 'result';
            result.textContent = 'å¼€å§‹å®Œæ•´æµ‹è¯•...\n\n';

            try {
                // 1. å¥åº·æ£€æŸ¥
                result.textContent += '1. æµ‹è¯•å¥åº·æ£€æŸ¥...\n';
                const healthRes = await fetch(`${API_BASE}/api/health`);
                const healthData = await healthRes.json();
                result.textContent += `   âœ“ ${JSON.stringify(healthData)}\n\n`;

                // 2. å‘é€éªŒè¯ç 
                result.textContent += '2. å‘é€éªŒè¯ç ...\n';
                const codeRes = await fetch(`${API_BASE}/api/auth/send-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: '13800138000' })
                });
                const codeData = await codeRes.json();
                result.textContent += `   âœ“ ${JSON.stringify(codeData)}\n\n`;

                // 3. ç™»å½•
                result.textContent += '3. ç™»å½•...\n';
                const loginRes = await fetch(`${API_BASE}/api/auth/verify-phone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: '13800138000', code: '123456' })
                });
                const loginData = await loginRes.json();
                if (loginData.token) {
                    updateToken(loginData.token);
                    result.textContent += `   âœ“ ç™»å½•æˆåŠŸï¼Œç”¨æˆ·: ${loginData.user.nickname}\n\n`;
                } else {
                    throw new Error('ç™»å½•å¤±è´¥');
                }

                // 4. æ‰“å¡
                result.textContent += '4. æ‰“å¡...\n';
                try {
                    const checkinRes = await fetch(`${API_BASE}/api/checkin`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const checkinData = await checkinRes.json();
                    result.textContent += `   âœ“ æ‰“å¡æˆåŠŸ: ${checkinData.checkin_date}\n\n`;
                } catch (e) {
                    result.textContent += `   âš  ${e.message}\n\n`;
                }

                // 5. è·å–æ‰“å¡çŠ¶æ€
                result.textContent += '5. è·å–æ‰“å¡çŠ¶æ€...\n';
                const statusRes = await fetch(`${API_BASE}/api/checkin/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statusData = await statusRes.json();
                result.textContent += `   âœ“ ${JSON.stringify(statusData)}\n\n`;

                // 6. è·å–ç”¨æˆ·ä¿¡æ¯
                result.textContent += '6. è·å–ç”¨æˆ·ä¿¡æ¯...\n';
                const meRes = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const meData = await meRes.json();
                result.textContent += `   âœ“ ç”¨æˆ·: ${meData.nickname}\n\n`;

                // 7. è·å–æ—¥å¿—åˆ—è¡¨
                result.textContent += '7. è·å–æ—¥å¿—åˆ—è¡¨...\n';
                const logsRes = await fetch(`${API_BASE}/api/logs`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const logsData = await logsRes.json();
                result.textContent += `   âœ“ æ—¥å¿—æ€»æ•°: ${logsData.total}\n\n`;

                result.textContent += 'ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼';
                result.className = 'result success';
            } catch (error) {
                result.textContent += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                result.className = 'result error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„token
        window.onload = function() {
            if (token) {
                updateToken(token);
            }
        };
    </script>
</body>
</html>

